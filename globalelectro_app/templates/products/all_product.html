{% extends "base.html" %}
{% load static %}

{% block title %}All Products - Global Electro{% endblock %}

{% block content %}
<div class="container py-5">

    <!-- عنوان الكاتيجوري -->
    {% if category_name %}
    <h2 class="mb-4 fw-bold brand-text text-center">Category: {{ category_name }}</h2>
    {% else %}
    <h2 class="mb-4 fw-bold brand-text text-center">All Products</h2>
    {% endif %}

    <!-- Search + Sort -->


    <!-- Sidebar Filters for Desktop -->
    <!-- Search + Sort -->
    <div class="container my-5">
        <div class="d-flex flex-column flex-md-row justify-content-center align-items-center mb-4 gap-3">
            <form method="GET"
                class="d-flex flex-column flex-md-row justify-content-center align-items-center gap-2 w-100 w-md-75">
                <input type="text" name="search" value="{{ search_query }}" class="form-control"
                    placeholder="Search products...">

                <select class="form-select" name="sort">
                    <option value="">Sort by Name</option>
                    <option value="newest" {% if sort_option == 'newest' %}selected{% endif %}>Newest</option>
                    <option value="price_low" {% if sort_option == 'price_low' %}selected{% endif %}>Price: Low to High
                    </option>
                    <option value="price_high" {% if sort_option == 'price_high' %}selected{% endif %}>Price: High to Low
                    </option>
                    <option value="featured" {% if sort_option == 'featured' %}selected{% endif %}>Featured</option>
                </select>

                <button type="submit" class="btn btn-primary">Search</button>
            </form>
            <form method="get" class="d-inline d-flex align-items-center gap-2 mt-3 mt-md-0">
                <!-- نخلي البحث والفرز محفوظين -->
                <input type="hidden" name="search" value="{{ search_query }}">
                <input type="hidden" name="sort" value="{{ sort_option }}">
                <input type="hidden" name="category" value="{{ category_name }}">

                <label for="currency-select" class="mb-0">Currency:</label>
                <select id="currency-select" name="currency" class="form-select w-auto" onchange="this.form.submit()">
                    <option value="EGP" {% if currency == 'EGP' %}selected{% endif %}>EGP</option>
                    <option value="USD" {% if currency == 'USD' %}selected{% endif %}>USD</option>
                    <option value="EUR" {% if currency == 'EUR' %}selected{% endif %}>EUR</option>
                    <option value="SAR" {% if currency == 'SAR' %}selected{% endif %}>SAR</option>
                </select>
            </form>
        </div>

        <div class="row g-4">
            <!-- Sidebar Filters for Desktop -->
            <div class="col-md-3 d-none d-md-block">
                <div class="card p-3 sticky-top" style="top:100px;">
                    <h5 class="fw-bold">Filters</h5>
                    <hr>

                    <!-- Categories -->
                    <h6>Categories</h6>
                    <ul class="list-unstyled">
                        <li>
                            <a href="{% url 'all_products' %}"
                                class="text-decoration-none {% if not category_name %}fw-bold text-primary{% endif %}">
                                All Products
                            </a>
                        </li>
                        {% for cat in categories %}
                        <li>
                            <a href="{% url 'all_products' %}?category={{ cat.name|urlencode }}"
                                class="text-decoration-none {% if category_name == cat.name %}fw-bold text-primary{% endif %}">
                                {{ cat.name }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>

                    <hr>
                    <!-- Price Range -->
                    <h6>Price Range</h6>
                    <input type="range" min="0" max="10000" class="form-range w-100">
                    <button class="btn btn-primary w-100 mt-2">Apply Filters</button>
                </div>
            </div>
            <!-- Products Grid -->
            <div class="col-md-9">
                <div class="row g-4">
                    {% for product in products %}
                    <div class="col-6 col-sm-6 col-md-4 col-lg-3 d-flex">
                        <div class="card shadow-sm product-card flex-fill h-100 position-relative"
                            style="transition: transform 0.3s;">

                            <div class="card-img-wrapper" style="height:200px; overflow:hidden;">
                                {% if product.image %}
                                <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.name }}"
                                    loading="lazy" style="width:100%; height:100%; object-fit:cover;">
                                {% else %}
                                <img src="{% static 'images/default-product.jpg' %}" class="card-img-top"
                                    alt="Default Image" loading="lazy"
                                    style="width:100%; height:100%; object-fit:cover;">
                                {% endif %}
                            </div>

                            <!-- Badges -->
                            {% if product.is_new %}
                            <span class="badge bg-info position-absolute top-2 start-2">New</span>
                            {% elif product.is_sale %}
                            <span class="badge bg-danger position-absolute top-2 start-2">Sale</span>
                            {% elif product.is_bestseller %}
                            <span class="badge bg-warning text-dark position-absolute top-2 start-2">Bestseller</span>
                            {% endif %}

                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">{{ product.name }}</h5>
                                <p class="card-text text-muted">{{ product.description|truncatechars:60 }}</p>

                                {% if product.stock_quantity|default:0 > 0 %}
                                <span class="badge bg-success mb-2">In Stock</span>
                                {% else %}
                                <span class="badge bg-danger mb-2">Out of Stock</span>
                                {% endif %}

                                <h4 class="text-primary fw-bold mb-3">
                                    {{ product.converted_price }} {{ currency }}
                                </h4>

                                <div class="mt-auto d-flex gap-2">
                                    <button class="btn btn-warning w-50 add-to-cart-btn"
                                        data-product-id="{{ product.product_id }}">Add to Cart</button>
                                    <button class="btn btn-outline-secondary w-50 view-details-btn"
                                        data-bs-toggle="modal" data-bs-target="#productModal"
                                        data-id="{{ product.product_id }}" data-name="{{ product.name }}"
                                        data-description="{{ product.description }}" data-price="{{ product.price }}"
                                        data-condition="{{ product.condition }}"
                                        data-stock="{{ product.stock_quantity }}"
                                        data-converted="{{ product.converted_price }}"
                                        data-image="{% if product.image %}{{ product.image.url }}{% else %}{% static 'images/default-product.jpg' %}{% endif %}">
                                        View
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-center mt-5">
                        {% if category_name %}
                        No products found in this category.
                        {% else %}
                        No products found.
                        {% endif %}
                    </p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-center mt-5">
            {% if products.has_previous %}
            <a href="?page={{ products.previous_page_number }}" class="btn btn-outline-secondary mx-1">Previous</a>
            {% endif %}
            <span class="btn btn-light mx-1">{{ products.number }}</span>
            {% if products.has_next %}
            <a href="?page={{ products.next_page_number }}" class="btn btn-outline-secondary mx-1">Next</a>
            {% endif %}
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalLabel">Product Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body row">
                    <div class="col-md-6">
                        <img id="modal-product-image" src="" class="img-fluid rounded" alt="Product">
                    </div>
                    <div class="col-md-6">
                        <h3 id="modal-product-name"></h3>
                        <p id="modal-product-description" class="text-muted"></p>
                        <ul class="list-unstyled">
                            <li><strong>Condition:</strong> <span id="modal-product-condition"></span></li>
                            <li><strong>Status:</strong> <span id="modal-product-stock"></span></li>
                        </ul>
                        <h4 class="text-primary fw-bold mb-3">
                            <span id="modal-product-price"></span>
                            <span>{{ currency }}</span>
                        </h4>
                        <div class="mb-3">
                            <label for="modal-product-quantity" class="form-label">Quantity</label>
                            <input type="number" id="modal-product-quantity" class="form-control" value="1" min="1"
                                style="max-width:120px;">
                        </div>
                        <button class="btn btn-warning w-100" id="modal-add-to-cart-btn">Add to Cart</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.querySelectorAll('.product-card').forEach(card => {
            card.addEventListener('mouseenter', () => {
                card.style.transform = 'translateY(-5px)';
                card.style.boxShadow = '0 8px 20px rgba(0,0,0,0.15)';
            });
            card.addEventListener('mouseleave', () => {
                card.style.transform = 'translateY(0)';
                card.style.boxShadow = '';
            });
        });

        const modal = document.getElementById('productModal');
        modal.addEventListener('show.bs.modal', event => {
            const button = event.relatedTarget;

            document.getElementById('modal-product-name').textContent = button.dataset.name;
            document.getElementById('modal-product-description').textContent = button.dataset.description;

            // السعر بالجنيه

            const converted = button.dataset.converted;
            const currency = "{{ currency }}";

            document.getElementById('modal-product-price').textContent = converted + " " + currency;
            document.getElementById('modal-product-condition').textContent = button.dataset.condition;
            document.getElementById('modal-product-stock').textContent =
                button.dataset.stock > 0 ? 'In Stock' : 'Out of Stock';
            document.getElementById('modal-product-image').src = button.dataset.image;
        });
    </script>
    {% endblock %}